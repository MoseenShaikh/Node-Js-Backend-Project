<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container mt-3">
  <!-- Back Button -->
  <div class="mb-4">
    <a href="/employees" class="btn btn-primary">&larr; Back</a>
  </div>

  <h1>Add Employee</h1>

  <form action="/employees" method="POST">
    <div class="mb-3">
      <label>Name</label>
      <input type="text" name="name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>Email</label>
      <input type="email" name="email" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>Job Title</label>
      <input type="text" name="jobTitle" class="form-control" required>
    </div>

    <div class="mb-3">
      <label>Department</label>
      <select name="department" class="form-select" required>
        <% if(departments && departments.length > 0) { %>
          <% departments.forEach(d => { %>
            <option value="<%= d._id %>"><%= d.name %></option>
          <% }) %>
        <% } %>
      </select>
    </div>

    <div class="mb-3">
      <label>Supervisor</label>
      <select name="supervisor" class="form-select">
        <option value="">No Supervisor</option>
        <% if(employees && employees.length > 0) { %>
          <% employees.forEach(e => { %>
            <option value="<%= e._id %>"><%= e.name %></option>
          <% }) %>
        <% } %>
      </select>
    </div>

    <!-- Country/State/City -->
    <div class="mb-3">
      <label>Country</label>
      <select id="country" name="country" class="form-select" required>
        <option value="">Select Country</option>
      </select>
    </div>

    <div class="mb-3">
      <label>State</label>
      <select id="state" name="state" class="form-select" required>
        <option value="">Select State</option>
      </select>
    </div>

    <div class="mb-3">
      <label>City</label>
      <select id="city" name="city" class="form-select" required>
        <option value="">Select City</option>
      </select>
    </div>

    <button type="submit" class="btn btn-primary">Add Employee</button>
  </form>
</div>

<script>
  const countrySelect = document.getElementById("country");
  const stateSelect = document.getElementById("state");
  const citySelect = document.getElementById("city");

  // Fetch all countries on page load
  fetch("https://countriesnow.space/api/v0.1/countries")
    .then(res => res.json())
    .then(data => {
      data.data.forEach(c => {
        const option = document.createElement("option");
        option.value = c.country;
        option.text = c.country;
        countrySelect.appendChild(option);
      });
    });

  countrySelect.addEventListener("change", function() {
    const selectedCountry = this.value;
    stateSelect.innerHTML = '<option value="">Select State</option>';
    citySelect.innerHTML = '<option value="">Select City</option>';

    if (!selectedCountry) return;

    fetch("https://countriesnow.space/api/v0.1/countries/states", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ country: selectedCountry })
    })
    .then(res => res.json())
    .then(data => {
      data.data.states.forEach(s => {
        const option = document.createElement("option");
        option.value = s.name;
        option.text = s.name;
        stateSelect.appendChild(option);
      });
    });
  });

  stateSelect.addEventListener("change", function() {
    const selectedCountry = countrySelect.value;
    const selectedState = this.value;
    citySelect.innerHTML = '<option value="">Select City</option>';

    if (!selectedState) return;

    fetch("https://countriesnow.space/api/v0.1/countries/state/cities", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ country: selectedCountry, state: selectedState })
    })
    .then(res => res.json())
    .then(data => {
      data.data.forEach(city => {
        const option = document.createElement("option");
        option.value = city;
        option.text = city;
        citySelect.appendChild(option);
      });
    });
  });
</script>
